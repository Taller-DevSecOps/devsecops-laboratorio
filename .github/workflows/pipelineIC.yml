name: Workflow
on:
  push:
    branches:
      - main
jobs:
  SAST:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Exists proyect on SonarCloud Service
        id: validateProjectSonar
        run: |
          curl -f -X POST -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/projects/create' -d 'name=${{github.event.repository.name}}' -d 'organization=claudioandre94-blip' -d 'project=${{github.event.repository.name}}' -d 'visibility=public'
          if [ $? -eq 0 ]; then
            echo "Proyecto creado exitosamente en SONARCLOUD"
            curl -f -X POST -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/project_branches/rename' -d 'name=main' -d 'project=${{github.event.repository.name}}'
          else
            echo "El proyecto ya existe en SonarCloud o hubo un problema al intentar crearlo"
          fi

      - name: Configure Node Project
        uses: actions/setup-node@v4

      - name: Install SonarCloud Node JS
        run : npm install -g @sonar/scan

      - name: Configure NodeJs Project
        run : npm install  

      - name: Run SonarCube on Project
        run : sonar-scanner -Dsonar.token=${{secrets.SONAR_TOKEN}} -Dsonar.organization=claudioandre94-blip  -Dsonar.projectKey=${{github.event.repository.name}}

      - name : Obtaing results from SonarCloud
        run :  |
          issueValidate=$(curl -s -X GET -u '${{secrets.SONAR_TOKEN}}:' 'https://sonarcloud.io/api/issues/search?branch=main&componentKeys=${{github.event.repository.name}}&facets=severities' | jq '.facets[0].values[1].count')
          echo "Cantidad de Issues Bloqueantes : $issueValidate"
          if [ "$issueValidate" -gt 0 ]; then
            echo "Se encontraron issues bloqueantes. Se quiebra el pipeline."
            exit 1
          else
            echo "No se encontraron issues bloqueantes. Pipeline Continua."
          fi
